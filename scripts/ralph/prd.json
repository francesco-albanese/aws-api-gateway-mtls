[
  {
    "id": "PRD-001",
    "category": "architectural",
    "description": "Setup prek pre-commit hooks with ruff lint and pyright type checking",
    "steps": [
      "Create .pre-commit-config.yaml with ruff (lint+format) and pyright hooks",
      "Add [tool.ruff] and [tool.pyright] config to root pyproject.toml",
      "Replace mypy with pyright in dev deps",
      "Update lambdas/health/pyproject.toml with pyright config",
      "Run prek install to activate git hooks",
      "Verify with prek run --all-files"
    ],
    "files": [".pre-commit-config.yaml", "pyproject.toml", "lambdas/health/pyproject.toml"],
    "passes": true
  },
  {
    "id": "PRD-002",
    "category": "architectural",
    "description": "Create project-local lambda-bootstrap skill for consistent lambda creation",
    "steps": [
      "Create .claude/skills/lambda-bootstrap/ directory",
      "Create SKILL.md with frontmatter: name + description (trigger: bootstrap/create new lambda)",
      "In body: document lambdas/<name>/ structure, pyproject.toml template, src/<name>/handler.py template",
      "Include ruff+pyright config, TypedDict patterns from health lambda",
      "Add references/pyproject-template.toml and references/handler-template.py",
      "Reference shared lambdas/Dockerfile (LAMBDA_NAME build-arg)"
    ],
    "files": [
      ".claude/skills/lambda-bootstrap/SKILL.md",
      ".claude/skills/lambda-bootstrap/references/pyproject-template.toml",
      ".claude/skills/lambda-bootstrap/references/handler-template.py"
    ],
    "passes": true
  },
  {
    "id": "PRD-003",
    "category": "integration",
    "description": "Create token lambda boilerplate for POST /oauth/token endpoint",
    "steps": [
      "Create lambdas/token/ directory structure",
      "Create pyproject.toml (no boto3 bundled - Lambda runtime includes it)",
      "Create src/token/__init__.py and handler.py with typed event structure",
      "Add placeholder logic: extract serialNumber from mTLS cert",
      "Add ECR repo mtls-api-token-lambda to terraform/ecr/ecr.tf",
      "Add POST /oauth/token route to terraform/environmental/api-gateway.tf",
      "Add token lambda resource to terraform/environmental/lambda.tf"
    ],
    "files": [
      "lambdas/token/pyproject.toml",
      "lambdas/token/src/token/__init__.py",
      "lambdas/token/src/token/handler.py",
      "terraform/ecr/ecr.tf",
      "terraform/environmental/api-gateway.tf",
      "terraform/environmental/lambda.tf"
    ],
    "passes": true
  },
  {
    "id": "PRD-004",
    "category": "testing",
    "description": "Write health lambda tests for production scenarios",
    "steps": [
      "Create lambdas/health/tests/ directory",
      "Create conftest.py with mock event fixtures",
      "test_handler_with_valid_mtls_cert - full cert metadata, extract CN",
      "test_handler_missing_client_cert - mtls.enabled=false, clientCN=None",
      "test_handler_dn_parsing_edge_cases - CN at start/end, special chars, empty DN",
      "test_handler_missing_validity_fields - cert without notBefore/notAfter",
      "test_response_json_structure - verify exact response format"
    ],
    "files": [
      "lambdas/health/tests/__init__.py",
      "lambdas/health/tests/conftest.py",
      "lambdas/health/tests/test_handler.py"
    ],
    "passes": true
  },
  {
    "id": "PRD-005",
    "category": "functional",
    "description": "Implement token lambda DynamoDB lookup and Cognito integration",
    "steps": [
      "Implement DynamoDB lookup by serialNumber from mTLS cert",
      "Validate cert status (not revoked, not expired)",
      "Read Cognito config from env vars (USER_POOL_ID, CLIENT_ID)",
      "Implement Cognito client_credentials token exchange",
      "Return JWT access_token or error response with proper status codes"
    ],
    "files": ["lambdas/token/src/token/handler.py"],
    "passes": true
  },
  {
    "id": "PRD-006",
    "category": "testing",
    "description": "Write token lambda tests for production scenarios",
    "steps": [
      "Create lambdas/token/tests/ directory with conftest.py",
      "test_token_valid_cert_in_dynamodb - cert exists, status=active, token issued",
      "test_token_cert_not_found - 404 response",
      "test_token_cert_revoked - 403 response",
      "test_token_cert_expired - 403 response",
      "test_token_cognito_error_handling - Cognito API failure, 500 response"
    ],
    "files": [
      "lambdas/token/tests/__init__.py",
      "lambdas/token/tests/conftest.py",
      "lambdas/token/tests/test_handler.py"
    ],
    "passes": true
  },
  {
    "id": "PRD-007",
    "category": "infrastructure",
    "description": "Create Cognito terraform resource with client_credentials flow",
    "steps": [
      "Create terraform/environmental/cognito.tf",
      "Add user pool (no self-signup, client_credentials only)",
      "Add resource server with API scope",
      "Add app client with client_credentials grant type",
      "Output client_id and user_pool_domain for Lambda env vars",
      "Wire outputs to token lambda environment variables"
    ],
    "files": [
      "terraform/environmental/cognito.tf",
      "terraform/environmental/outputs.tf",
      "terraform/environmental/lambda.tf"
    ],
    "passes": true
  },
  {
    "id": "PRD-008",
    "category": "testing",
    "description": "Write ca_operations tests for certificate chain validation",
    "steps": [
      "Create ca_operations/tests/ directory",
      "Create conftest.py with temp directory fixtures",
      "test_bootstrap_creates_valid_chain - Root signs Intermediate correctly",
      "test_client_cert_signed_by_intermediate - chain validation works",
      "test_truststore_bundle_format - PEM bundle parseable",
      "test_certificate_metadata_extraction - serial, validity dates correct"
    ],
    "files": [
      "ca_operations/tests/__init__.py",
      "ca_operations/tests/conftest.py",
      "ca_operations/tests/test_ca_manager.py",
      "ca_operations/tests/test_cert_utils.py"
    ],
    "passes": true
  },
  {
    "id": "PRD-009",
    "category": "future",
    "description": "Custom authorizer lambda (JWT + mTLS validation)",
    "steps": [
      "Create lambdas/authorizer/ boilerplate",
      "Validate Cognito JWT signature",
      "Check mTLS cert serialNumber matches token's client context",
      "Return IAM policy (allow/deny)",
      "Wire to API Gateway as Lambda authorizer"
    ],
    "files": [
      "lambdas/authorizer/pyproject.toml",
      "lambdas/authorizer/src/authorizer/handler.py",
      "terraform/environmental/api-gateway.tf"
    ],
    "passes": true
  },
  {
    "id": "PRD-010",
    "category": "refactoring",
    "description": "Refactor token lambda for modularity and fix type issues",
    "steps": [
      "Extract TypedDicts to types.py",
      "Extract DynamoDB operations to cert_metadata.py",
      "Extract Cognito token exchange to cognito_exchange.py",
      "Extract cert validation to cert_validator.py",
      "Group small helpers into utils.py (serial extraction, json response)",
      "Replace dict[str, Any] with TypedDicts in tests",
      "Remove underscore prefix from module-level public functions",
      "Slim handler.py to orchestration only (~40 lines)"
    ],
    "files": [
      "lambdas/token/src/token/types.py",
      "lambdas/token/src/token/cert_metadata.py",
      "lambdas/token/src/token/cognito_exchange.py",
      "lambdas/token/src/token/cert_validator.py",
      "lambdas/token/src/token/utils.py",
      "lambdas/token/src/token/handler.py",
      "lambdas/token/tests/conftest.py",
      "lambdas/token/tests/test_handler.py"
    ],
    "passes": true
  }
]
