name: Build Lambda Images

on:
  push:
    branches: [main]
    paths: ["lambdas/**"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - sandbox
          - staging
          - uat
          - production
        default: "sandbox"

env:
  AWS_REGION: eu-west-2

jobs:
  detect-lambdas:
    name: Detect Changed Lambdas
    runs-on: ubuntu-latest
    outputs:
      lambdas: ${{ steps.detect.outputs.lambdas }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect Lambda directories
        id: detect
        run: |
          # Find all Lambda directories with pyproject.toml (excludes shared Dockerfile dir and adot support dir)
          lambdas=$(find lambdas -maxdepth 2 -name pyproject.toml -not -path "lambdas/adot/*" -exec dirname {} \; | xargs -I {} basename {} | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "lambdas=$lambdas" >> $GITHUB_OUTPUT
          echo "Detected Lambdas: $lambdas"

  build-and-push:
    name: Build ${{ matrix.lambda }}
    needs: detect-lambdas
    runs-on: ubuntu-latest
    if: needs.detect-lambdas.outputs.lambdas != '[]'

    strategy:
      matrix:
        lambda: ${{ fromJson(needs.detect-lambdas.outputs.lambdas) }}

    permissions:
      id-token: write
      contents: read

    environment:
      name: ${{ steps.set-env.outputs.environment }}

    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=sandbox" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS
        id: aws-config
        uses: ./.github/actions/configure-aws-env
        with:
          environment: ${{ steps.set-env.outputs.environment }}
          aws_region: ${{ env.AWS_REGION }}
          role_arn: ${{ secrets.AWS_ROLE_ARN }}
          ecr_registry: ${{ secrets.ECR_REGISTRY }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build and push ${{ matrix.lambda }} Lambda
        uses: docker/build-push-action@v6
        with:
          context: lambdas
          platforms: linux/arm64
          push: true
          provenance: false
          build-args: LAMBDA_NAME=${{ matrix.lambda }}
          cache-from: type=gha,scope=${{ matrix.lambda }}
          cache-to: type=gha,mode=max,scope=${{ matrix.lambda }}
          tags: |
            ${{ steps.aws-config.outputs.ecr_registry }}/mtls-api-${{ matrix.lambda }}-lambda:${{ github.sha }}
            ${{ steps.aws-config.outputs.ecr_registry }}/mtls-api-${{ matrix.lambda }}-lambda:latest

  deploy:
    name: Deploy Lambdas
    needs: build-and-push
    # Non-sandbox environments require manual terraform-deploy workflow dispatch
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'sandbox')
    uses: ./.github/workflows/terraform-deploy.yml
    with:
      environment: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || 'sandbox' }}
      health_lambda_image_tag: ${{ github.sha }}
      authorizer_lambda_image_tag: ${{ github.sha }}
    secrets: inherit
