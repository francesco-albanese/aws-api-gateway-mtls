name: Setup Terraform

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to (sandbox/staging/uat/production)'
        required: true
        type: string
      aws_region:
        description: 'AWS region'
        required: false
        type: string
        default: 'eu-west-2'
    outputs:
      terraform_version:
        description: 'Terraform version used'
        value: ${{ jobs.setup.outputs.terraform_version }}

jobs:
  setup:
    name: Configure AWS & Setup Terraform
    runs-on: ubuntu-latest

    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read   # Required for checkout

    outputs:
      terraform_version: ${{ steps.setup-tf.outputs.terraform-version }}

    steps:
      - name: Select AWS Role ARN
        id: select-role
        run: |
          ENV="${{ inputs.environment }}"
          case "$ENV" in
            sandbox)
              echo "role_arn=${{ secrets.AWS_ROLE_ARN_SANDBOX }}" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "role_arn=${{ secrets.AWS_ROLE_ARN_STAGING }}" >> $GITHUB_OUTPUT
              ;;
            uat)
              echo "role_arn=${{ secrets.AWS_ROLE_ARN_UAT }}" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "role_arn=${{ secrets.AWS_ROLE_ARN_PRODUCTION }}" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "Error: Unknown environment $ENV"
              exit 1
              ;;
          esac

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.select-role.outputs.role_arn }}
          aws-region: ${{ inputs.aws_region }}

      - name: Setup Terraform
        id: setup-tf
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.13.4'
