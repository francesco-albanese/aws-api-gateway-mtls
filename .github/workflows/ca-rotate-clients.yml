name: Rotate Client Certificates

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rotate client certificates for'
        required: true
        type: choice
        options:
          - sandbox
          - staging
          - uat
          - production
        default: 'sandbox'
      client_id:
        description: 'Specific client ID to rotate (leave empty if using rotate_all)'
        required: false
        type: string
        default: ''
      rotate_all:
        description: 'Rotate all active client certificates'
        required: true
        type: boolean
        default: false
      dry_run:
        description: 'Preview rotation without making AWS changes'
        required: true
        type: boolean
        default: true

env:
  AWS_REGION: eu-west-2
  PYTHON_VERSION: '3.13.7'

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: ubuntu-latest
    steps:
      - name: Check mutually exclusive inputs
        run: |
          CLIENT_ID="${{ github.event.inputs.client_id }}"
          ROTATE_ALL="${{ github.event.inputs.rotate_all }}"

          if [ -z "$CLIENT_ID" ] && [ "$ROTATE_ALL" != "true" ]; then
            echo "::error::One of client_id or rotate_all is required"
            exit 1
          fi

          if [ -n "$CLIENT_ID" ] && [ "$ROTATE_ALL" = "true" ]; then
            echo "::error::client_id and rotate_all are mutually exclusive"
            exit 1
          fi

  rotate-clients:
    name: Rotate Client Certificates
    runs-on: ubuntu-latest
    needs: validate-inputs

    permissions:
      id-token: write
      contents: read

    environment:
      name: ${{ github.event.inputs.environment }}

    env:
      ACCOUNT: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python & UV
        uses: ./.github/actions/setup-python-uv
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configure AWS
        uses: ./.github/actions/configure-aws-env
        with:
          environment: ${{ env.ACCOUNT }}
          aws_region: ${{ env.AWS_REGION }}
          role_arn: ${{ secrets.AWS_ROLE_ARN }}

      - name: Run client rotation script
        env:
          AWS_PROFILE: ""
        run: |
          OUTPUT_DIR="ca_operations/output/${{ env.ACCOUNT }}/client-rotation"
          mkdir -p "$OUTPUT_DIR"

          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi

          CLIENT_FLAG=""
          if [ -n "${{ github.event.inputs.client_id }}" ]; then
            CLIENT_FLAG="--client-id ${{ github.event.inputs.client_id }}"
          elif [ "${{ github.event.inputs.rotate_all }}" = "true" ]; then
            CLIENT_FLAG="--all"
          fi

          uv run --group ca python -m ca_operations.scripts.rotate_client_certs \
            --environment "${{ env.ACCOUNT }}" \
            --project-name "apigw-mtls" \
            --dynamodb-table "mtls-clients-metadata" \
            --output-dir "$OUTPUT_DIR" \
            $CLIENT_FLAG \
            $DRY_RUN_FLAG

      - name: Upload rotation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: client-rotation-${{ env.ACCOUNT }}-${{ github.run_id }}
          path: ca_operations/output/${{ env.ACCOUNT }}/client-rotation
          retention-days: 1

      - name: Clean up sensitive files
        if: always()
        run: |
          rm -rf ca_operations/output/${{ env.ACCOUNT }}

      - name: Summary
        if: success()
        run: |
          echo "## Client Certificate Rotation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ACCOUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.client_id }}" ]; then
            echo "**Client ID:** ${{ github.event.inputs.client_id }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Scope:** All active clients" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "> Preview only - no AWS changes were made" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Actions Performed:" >> $GITHUB_STEP_SUMMARY
            echo "- Fetched intermediate CA from SSM" >> $GITHUB_STEP_SUMMARY
            echo "- Re-issued client certificate(s)" >> $GITHUB_STEP_SUMMARY
            echo "- Updated DynamoDB metadata (atomic revoke + insert)" >> $GITHUB_STEP_SUMMARY
            echo "- Updated SSM client certificate parameters" >> $GITHUB_STEP_SUMMARY
          fi
